parameters:
  azureSubscription: ''
  name: ''
  secretName: ''
  vaultName: ''

steps:
- task: AzurePowerShell@5
  displayName: 'Check expiration'
  name: ${{ parameters.name }}
  inputs:
    azureSubscription: ${{ parameters.azureSubscription }}
    ScriptType: InlineScript
    FailOnStandardError: true
    azurePowerShellVersion: 'LatestVersion'
    Inline: |
      $SECRETVAULTNAME = "${{ parameters.vaultName }}"
      $SECRET_NAME = "${{ parameters.secretName }}"
      Write-Host "Key vault: $SECRETVAULTNAME"

      $secret = Get-AzKeyVaultSecret -VaultName $SECRETVAULTNAME -Name $SECRET_NAME

      $generateNew = $false

      if ($null -ne $secret.Tags -and $secret.Tags["auto-generated"] -eq "true") {
          Write-Host "Located autogenerated secret"

          ## Check expires flag
          $delta = $secret.Expires - (Get-Date)

          Write-Host "Secret expires in $($delta.Days) days"
          if ($delta.Days -lt 60) {
              $generateNew = $true
          }

      } else {
          Write-Host "Secret not autogenerated, creating new..."
          $generateNew = $true
      }
    
      if (-not $generateNew) {
          Write-Host "No need to generate secret..."
          Write-Host "##vso[task.setvariable variable=generateNew;isOutput=true]false"
          Write-Host "Set variable [${{ parameters.name }}.generateNew] -> false"
      } else {
          Write-Host "Generating new secret..."
          Write-Host "##vso[task.setvariable variable=generateNew;isOutput=true]true"
          Write-Host "Set variable [${{ parameters.name }}.generateNew] -> true"
      }


      ## Detect expired keys to purge from ad app
      Write-Host "----- Checking for secrets to prune -----"
      
      $keysToDelete = @()

      $secretWithVersions = Get-AzKeyVaultSecret -VaultName $SECRETVAULTNAME -Name $SECRET_NAME -IncludeVersions
      foreach ($s in $secretWithVersions) {    
          Write-Host "Processing key: $($s.Id)"
          $isAutoGenerated = $null -ne $s.Tags -and $s.Tags["auto-generated"] -eq "true"

          if ($isAutoGenerated) {
              $keyId = $s.Tags["keyId"]
              $isDeleted = $s.Tags.ContainsKey("deleted")

              if ([string]::IsNullOrEmpty($keyId)) {
                  Write-Host "`tCould not locate any key id, skipping"
                  continue
              }

              if ($isDeleted -eq $true) { Write-Host "`tAlready deleted @ $($s.Tags["deleted"])"; continue }
              if ($s.Expires -lt (Get-Date)) {            
                  Write-Host "`tExpired secret.. Deleting key id: $keyId"
                  $newTags = $s.Tags
                  $newTags["deleted"] = (Get-Date).ToString()
                  Update-AzKeyVaultSecret $s -Version $s.Version -Tag $newTags         
                  
                  $keysToDelete += $keyId
              }
          } else {
              Write-Host "Non auto generated key, skipping"
          }
      }
      
      $keysToDeleteString = [string]::Join(";", $keysToDelete)
      Write-Host "##vso[task.setvariable variable=keysToDelete;isOutput=true]$keysToDeleteString"
    