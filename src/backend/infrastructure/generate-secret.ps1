param(
    [string]$applicationId,
    [string]$keyVaultName
)

$SECRET_NAME = "AzureAd--ClientSecret"
$AAD_APP_ID = $applicationId
$SECRETVAULTNAME = $keyVaultName

Write-Host "Application ID: $AAD_APP_ID"
Write-Host "Key vault: $SECRETVAULTNAME"

$secret = Get-AzKeyVaultSecret -VaultName $SECRETVAULTNAME -Name $SECRET_NAME

$generateNew = $false

if ($null -ne $secret.Tags -and $secret.Tags["auto-generated"] -eq "true") {
    Write-Host "Located autogenerated secret"

    ## Check expires flag
    $delta = $secret.Expires - (Get-Date)

    Write-Host "Secret expires in $($delta.Days) days"
    if ($delta.Days -lt 60) {
        $generateNew = $true
    }

} else {
    Write-Host "Secret not autogenerated, creating new..."
    $generateNew = $true
}

if (-not $generateNew) {
    Write-Host "No need to generate secret..."
    return
} else {
    Write-Host "Generating new secret..."
}

Get-Command -Name "New-AzADAppCredential"
Get-Module -Name Az.Resources
## Generate secret on aad app
$startDate = Get-Date
$endDate = $startDate.AddMonths(6)

$credential = @{
    DisplayName = "Resources - $keyVaultName"
    StartDateTime = $startDate
    EndDateTime = $endDate
}

$app = Get-AzADApplication -ApplicationId $AAD_APP_ID

$name = "Resources - $keyVaultName"
$creds = New-Object `
             -TypeName "Microsoft.Azure.PowerShell.Cmdlets.Resources.MSGraph.Models.ApiV10.MicrosoftGraphPasswordCredential" `
             -Property @{ 'DisplayName' = $name; 'StartDateTime' = $startDate; 'EndDateTime' = $endDate }

$newSecret = New-AzADAppCredential -ObjectId $app.Id -PasswordCredentials $creds


#$newSecret = New-AzADAppCredential -ObjectId $app.Id -PasswordCredentials $credential

Write-Host "New secret [$($newSecret.Hint)************] generated with expiration date $endDate, key id [$($newSecret.KeyId)]"

$secretValue = ConvertTo-SecureString -String $newSecret.SecretText -AsPlainText -Force
## Add to key vault
Set-AzKeyVaultSecret -VaultName $SECRETVAULTNAME -Name $SECRET_NAME -SecretValue $secretValue -Expires $endDate -Tag @{ "auto-generated" = "true"; "keyId" = $newSecret.KeyId; "hint" = $newSecret.Hint }


