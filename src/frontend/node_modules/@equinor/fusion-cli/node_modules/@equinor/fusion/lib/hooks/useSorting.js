import { useState, useMemo } from 'react';
/**
 * Gets the value from an item based on the accessor (which may be a string or a function)
 * @param item The item
 * @param accessor The accessor
 */
const getValue = (item, accessor) => {
    if (!item) {
        return null;
    }
    if (typeof accessor === 'string') {
        const value = item[accessor];
        return value !== null && typeof value !== 'undefined' ? value.toString() : null;
    }
    const accessorFunction = accessor;
    const value = accessorFunction(item);
    return value ? value.toString() : null;
};
/**
 * Apply sort to a data set
 * @param data The data to sort
 * @param sortBy The property to sort by or an accessor function
 * @param direction Sort direction
 */
export const applySorting = (data, sortBy = null, direction = null) => {
    if (!sortBy || !direction) {
        return data;
    }
    const comparer = new Intl.Collator('co', { numeric: true }).compare;
    return data.slice().sort((a, b) => {
        const aValue = getValue(a, sortBy);
        const bValue = getValue(b, sortBy);
        // Sort null/falsy values at the end/beginning for asc/desc respectively
        if (!aValue && !bValue) {
            return 0;
        }
        else if (!aValue) {
            return direction === 'asc' ? 1 : -1;
        }
        else if (!bValue) {
            return direction === 'asc' ? -1 : 1;
        }
        return direction === 'asc' ? comparer(aValue, bValue) : comparer(bValue, aValue);
    });
};
/**
 * Cycle the direction. E.g. null > asc > desc > null > repeat
 * @param direction Current direction
 */
const cycleSortDirection = (direction) => {
    if (!direction) {
        return 'asc';
    }
    else if (direction === 'asc') {
        return 'desc';
    }
    return null;
};
/**
 * Sorting hook that takes care of sorting and storing the sort by and direction
 * If the default sort by of direction is null, no initial sorting will be applied
 * @param data The data to sort
 * @param defaultSortBy The default sort property
 * @param defaultDirection The default direction
 */
export const useSorting = (data, defaultSortBy = null, defaultDirection = null) => {
    const [sortBy, setSortBy] = useState(defaultSortBy);
    const [direction, setDirection] = useState(defaultDirection);
    const sortedData = useMemo(() => applySorting(data, sortBy, direction), [
        data,
        sortBy,
        direction,
    ]);
    const resetSorting = () => {
        setSortBy(null);
        setDirection(null);
    };
    const updateSortBy = (newSortBy, newDirection) => {
        // Figure out the new direction
        newDirection =
            newDirection || sortBy === newSortBy || !newSortBy
                ? cycleSortDirection(direction)
                : cycleSortDirection(null);
        // The new sort by accessor might be a function,
        // passing it directly to setSortBy would invoke it as a setter
        setSortBy(() => newSortBy);
        setDirection(newDirection);
    };
    return {
        sortedData,
        sortBy,
        direction,
        setSortBy: updateSortBy,
        resetSorting,
    };
};
