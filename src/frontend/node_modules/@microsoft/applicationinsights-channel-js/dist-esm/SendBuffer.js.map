{"version":3,"file":"SendBuffer.js.map","sources":["SendBuffer.js"],"sourcesContent":["import { Util } from '@microsoft/applicationinsights-common';\r\nimport { LoggingSeverity, _InternalMessageId, getJSON, CoreUtils } from '@microsoft/applicationinsights-core-js';\r\nimport dynamicProto from '@microsoft/dynamicproto-js';\r\n/*\r\n * An array based send buffer.\r\n */\r\nvar ArraySendBuffer = /** @class */ (function () {\r\n    function ArraySendBuffer(config) {\r\n        var _buffer = [];\r\n        dynamicProto(ArraySendBuffer, this, function (_self) {\r\n            _self.enqueue = function (payload) {\r\n                _buffer.push(payload);\r\n            };\r\n            _self.count = function () {\r\n                return _buffer.length;\r\n            };\r\n            _self.clear = function () {\r\n                _buffer.length = 0;\r\n            };\r\n            _self.getItems = function () {\r\n                return _buffer.slice(0);\r\n            };\r\n            _self.batchPayloads = function (payload) {\r\n                if (payload && payload.length > 0) {\r\n                    var batch = config.emitLineDelimitedJson() ?\r\n                        payload.join(\"\\n\") :\r\n                        \"[\" + payload.join(\",\") + \"]\";\r\n                    return batch;\r\n                }\r\n                return null;\r\n            };\r\n            _self.markAsSent = function (payload) {\r\n                _self.clear();\r\n            };\r\n            _self.clearSent = function (payload) {\r\n                // not supported\r\n            };\r\n        });\r\n    }\r\n    ArraySendBuffer.prototype.enqueue = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    ArraySendBuffer.prototype.count = function () {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n        return 0;\r\n    };\r\n    ArraySendBuffer.prototype.clear = function () {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    ArraySendBuffer.prototype.getItems = function () {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n        return null;\r\n    };\r\n    ArraySendBuffer.prototype.batchPayloads = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n        return null;\r\n    };\r\n    ArraySendBuffer.prototype.markAsSent = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    ArraySendBuffer.prototype.clearSent = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    return ArraySendBuffer;\r\n}());\r\nexport { ArraySendBuffer };\r\n/*\r\n * Session storage buffer holds a copy of all unsent items in the browser session storage.\r\n */\r\nvar SessionStorageSendBuffer = /** @class */ (function () {\r\n    function SessionStorageSendBuffer(logger, config) {\r\n        var _bufferFullMessageSent = false;\r\n        // An in-memory copy of the buffer. A copy is saved to the session storage on enqueue() and clear().\r\n        // The buffer is restored in a constructor and contains unsent events from a previous page.\r\n        var _buffer;\r\n        dynamicProto(SessionStorageSendBuffer, this, function (_self) {\r\n            var bufferItems = _getBuffer(SessionStorageSendBuffer.BUFFER_KEY);\r\n            var notDeliveredItems = _getBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY);\r\n            _buffer = bufferItems.concat(notDeliveredItems);\r\n            // If the buffer has too many items, drop items from the end.\r\n            if (_buffer.length > SessionStorageSendBuffer.MAX_BUFFER_SIZE) {\r\n                _buffer.length = SessionStorageSendBuffer.MAX_BUFFER_SIZE;\r\n            }\r\n            _setBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY, []);\r\n            _setBuffer(SessionStorageSendBuffer.BUFFER_KEY, _buffer);\r\n            _self.enqueue = function (payload) {\r\n                if (_buffer.length >= SessionStorageSendBuffer.MAX_BUFFER_SIZE) {\r\n                    // sent internal log only once per page view\r\n                    if (!_bufferFullMessageSent) {\r\n                        logger.throwInternal(LoggingSeverity.WARNING, _InternalMessageId.SessionStorageBufferFull, \"Maximum buffer size reached: \" + _buffer.length, true);\r\n                        _bufferFullMessageSent = true;\r\n                    }\r\n                    return;\r\n                }\r\n                _buffer.push(payload);\r\n                _setBuffer(SessionStorageSendBuffer.BUFFER_KEY, _buffer);\r\n            };\r\n            _self.count = function () {\r\n                return _buffer.length;\r\n            };\r\n            _self.clear = function () {\r\n                _buffer = [];\r\n                _setBuffer(SessionStorageSendBuffer.BUFFER_KEY, []);\r\n                _setBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY, []);\r\n                _bufferFullMessageSent = false;\r\n            };\r\n            _self.getItems = function () {\r\n                return _buffer.slice(0);\r\n            };\r\n            _self.batchPayloads = function (payload) {\r\n                if (payload && payload.length > 0) {\r\n                    var batch = config.emitLineDelimitedJson() ?\r\n                        payload.join(\"\\n\") :\r\n                        \"[\" + payload.join(\",\") + \"]\";\r\n                    return batch;\r\n                }\r\n                return null;\r\n            };\r\n            _self.markAsSent = function (payload) {\r\n                _buffer = _removePayloadsFromBuffer(payload, _buffer);\r\n                _setBuffer(SessionStorageSendBuffer.BUFFER_KEY, _buffer);\r\n                var sentElements = _getBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY);\r\n                if (sentElements instanceof Array && payload instanceof Array) {\r\n                    sentElements = sentElements.concat(payload);\r\n                    if (sentElements.length > SessionStorageSendBuffer.MAX_BUFFER_SIZE) {\r\n                        // We send telemetry normally. If the SENT_BUFFER is too big we don't add new elements\r\n                        // until we receive a response from the backend and the buffer has free space again (see clearSent method)\r\n                        logger.throwInternal(LoggingSeverity.CRITICAL, _InternalMessageId.SessionStorageBufferFull, \"Sent buffer reached its maximum size: \" + sentElements.length, true);\r\n                        sentElements.length = SessionStorageSendBuffer.MAX_BUFFER_SIZE;\r\n                    }\r\n                    _setBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY, sentElements);\r\n                }\r\n            };\r\n            _self.clearSent = function (payload) {\r\n                var sentElements = _getBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY);\r\n                sentElements = _removePayloadsFromBuffer(payload, sentElements);\r\n                _setBuffer(SessionStorageSendBuffer.SENT_BUFFER_KEY, sentElements);\r\n            };\r\n            function _removePayloadsFromBuffer(payloads, buffer) {\r\n                var remaining = [];\r\n                CoreUtils.arrForEach(buffer, function (value) {\r\n                    if (!CoreUtils.isFunction(value) && CoreUtils.arrIndexOf(payloads, value) === -1) {\r\n                        remaining.push(value);\r\n                    }\r\n                });\r\n                return remaining;\r\n            }\r\n            function _getBuffer(key) {\r\n                var prefixedKey = key;\r\n                try {\r\n                    prefixedKey = config.namePrefix && config.namePrefix() ? config.namePrefix() + \"_\" + prefixedKey : prefixedKey;\r\n                    var bufferJson = Util.getSessionStorage(logger, prefixedKey);\r\n                    if (bufferJson) {\r\n                        var buffer = getJSON().parse(bufferJson);\r\n                        if (CoreUtils.isString(buffer)) {\r\n                            // When using some version prototype.js the stringify / parse cycle does not decode array's correctly\r\n                            buffer = getJSON().parse(buffer);\r\n                        }\r\n                        if (buffer && Util.isArray(buffer)) {\r\n                            return buffer;\r\n                        }\r\n                    }\r\n                }\r\n                catch (e) {\r\n                    logger.throwInternal(LoggingSeverity.CRITICAL, _InternalMessageId.FailedToRestoreStorageBuffer, \" storage key: \" + prefixedKey + \", \" + Util.getExceptionName(e), { exception: Util.dump(e) });\r\n                }\r\n                return [];\r\n            }\r\n            function _setBuffer(key, buffer) {\r\n                var prefixedKey = key;\r\n                try {\r\n                    prefixedKey = config.namePrefix && config.namePrefix() ? config.namePrefix() + \"_\" + prefixedKey : prefixedKey;\r\n                    var bufferJson = JSON.stringify(buffer);\r\n                    Util.setSessionStorage(logger, prefixedKey, bufferJson);\r\n                }\r\n                catch (e) {\r\n                    // if there was an error, clear the buffer\r\n                    // telemetry is stored in the _buffer array so we won't loose any items\r\n                    Util.setSessionStorage(logger, prefixedKey, JSON.stringify([]));\r\n                    logger.throwInternal(LoggingSeverity.WARNING, _InternalMessageId.FailedToSetStorageBuffer, \" storage key: \" + prefixedKey + \", \" + Util.getExceptionName(e) + \". Buffer cleared\", { exception: Util.dump(e) });\r\n                }\r\n            }\r\n        });\r\n    }\r\n    SessionStorageSendBuffer.prototype.enqueue = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    SessionStorageSendBuffer.prototype.count = function () {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n        return 0;\r\n    };\r\n    SessionStorageSendBuffer.prototype.clear = function () {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    SessionStorageSendBuffer.prototype.getItems = function () {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n        return null;\r\n    };\r\n    SessionStorageSendBuffer.prototype.batchPayloads = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n        return null;\r\n    };\r\n    SessionStorageSendBuffer.prototype.markAsSent = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    SessionStorageSendBuffer.prototype.clearSent = function (payload) {\r\n        // @DynamicProtoStub -- DO NOT add any code as this will be removed during packaging\r\n    };\r\n    SessionStorageSendBuffer.BUFFER_KEY = \"AI_buffer\";\r\n    SessionStorageSendBuffer.SENT_BUFFER_KEY = \"AI_sentBuffer\";\r\n    // Maximum number of payloads stored in the buffer. If the buffer is full, new elements will be dropped.\r\n    SessionStorageSendBuffer.MAX_BUFFER_SIZE = 2000;\r\n    return SessionStorageSendBuffer;\r\n}());\r\nexport { SessionStorageSendBuffer };\r\n//# sourceMappingURL=SendBuffer.js.map"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;wDAuBM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;iEAuBM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}